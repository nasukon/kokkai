<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>衆議院 会派別議席数シミュレーター (半円版)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js v7 CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Interフォントの読み込み */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* チェックボックスのカスタムスタイル */
        .party-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        /* D3のツールチップ用（非表示） */
        .d3-tooltip {
            position: absolute;
            visibility: hidden;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            pointer-events: none;
            transition: opacity 0.2s;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8 flex items-center justify-center">

    <div class="w-full max-w-6xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-6 text-white">
            衆議院 会派別議席数シミュレーター (総議席数: 465)
        </h1>

        <div class="flex flex-col md:flex-row gap-6 md:gap-8">

            <!-- 左側: グラフコンテナ -->
            <div class="md:w-1/2 flex flex-col items-center justify-center bg-gray-900 p-4 rounded-lg shadow-inner min-h-[300px] md:min-h-[300px] overflow-hidden">
                <!-- SVGの高さを調整 -->
                <div id="chart-container" class="w-full"></div>
                <div class="d3-tooltip"></div>
            </div>

            <!-- 右側: シミュレーションコントロール -->
            <div class="md:w-1/2">
                <!-- シミュレーション結果表示 -->
                <div id="simulation-result" class="bg-gray-700 rounded-lg p-6 mb-6 shadow-md transition-all duration-300">
                    <h2 class="text-lg font-semibold mb-3 text-gray-300">選択した会派の合計議席数</h2>
                    <div id="total-seats-display" class="text-5xl font-bold text-yellow-400">0 議席</div>
                    <div id="majority-status" class="text-xl font-semibold mt-2 text-yellow-400">過半数 (233議席) 未達</div>
                </div>

                <!-- 会派選択チェックボックス -->
                <div class="bg-gray-700 rounded-lg p-6 shadow-md">
                    <h2 class="text-lg font-semibold mb-4 text-gray-300 border-b border-gray-600 pb-2">会派を選択</h2>
                    <div id="controls-container" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                        <!-- チェックボックスはJSで動的に生成されます -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. データ定義 ---
        const partyData = [
            { id: 'jimin', name: '自由民主党・無所属の会', seats: 196, color: '#3182CE' },
            { id: 'rikken', name: '立憲民主党・無所属 (※)', seats: 148, color: '#48BB78' },
            { id: 'ishin', name: '日本維新の会 (※)', seats: 35, color: '#F56565' },
            { id: 'komei', name: '公明党', seats: 24, color: '#ECC94B' },
            { id: 'kokumin', name: '国民民主党・無所属クラブ (※)', seats: 27, color: '#ED8936' },
            { id: 'kyosan', name: '日本共産党', seats: 8, color: '#9F7AEA' },
            { id: 'reiwa', name: 'れいわ新選組', seats: 9, color: '#F687B3' },
            { id: 'yushi', name: '有志の会', seats: 4, color: '#4FD1C5' },
            { id: 'sansei', name: '参政党', seats: 3, color: '#A0AEC0' },
            { id: 'kaikaku', name: '改革の会', seats: 3, color: '#718096' },
            { id: 'genzei', name: '減税保守こども', seats: 3, color: '#CBD5E0' },
            { id: 'mushozoku', name: '無所属 (※)', seats: 5, color: '#E2E8F0' }
        ];

        const TOTAL_SEATS = 465;
        const MAJORITY_LINE_SEATS = 233;

        // --- 2. D3.js グラフ設定 ---
        const width = 450;
        const height = 250; // 半円なので高さを低く
        const margin = 20;
        const radius = Math.min(width / 2, height) - margin;

        const svg = d3.select("#chart-container")
            .append("svg")
            .attr("viewBox", `0 0 ${width} ${height + margin}`) // viewBoxでレスポンシブに
            .attr("preserveAspectRatio", "xMidYMax meet")
            .append("g")
            // SVGの下辺中央を半円の中心にする
            .attr("transform", `translate(${width / 2}, ${height})`);

        const tooltip = d3.select(".d3-tooltip");

        // パイレイアウト (半円: -90度から+90度... ではなく -180度から0度)
        const pie = d3.pie()
            .value(d => d.seats)
            .sort(null) // データの順序（＝選択順）を維持
            .startAngle(-Math.PI) // 左端 (9時の位置)
            .endAngle(0);         // 右端 (3時の位置)

        // アーク（円弧）ジェネレータ
        const arc = d3.arc()
            .innerRadius(radius * 0.5)
            .outerRadius(radius * 0.9);
        
        const arcHover = d3.arc()
            .innerRadius(radius * 0.5)
            .outerRadius(radius);

        // --- 3. 過半数ラインの描画 (静的) ---
        // グラフは -Math.PI (-180度) から 0 (0度) まで
        // 0議席 = -Math.PI
        // 465議席 = 0
        const majorityPercentage = MAJORITY_LINE_SEATS / TOTAL_SEATS;
        // 角度を計算 (線形補間)
        const majorityAngle = -Math.PI + (Math.PI * majorityPercentage);

        svg.append("line")
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", Math.cos(majorityAngle) * radius * 1.05)
            .attr("y2", Math.sin(majorityAngle) * radius * 1.05) // sin(-90度)は -1
            .attr("stroke", "#F56565") // Red-500
            .attr("stroke-width", 2)
            .attr("stroke-dasharray", "5,5");

        svg.append("text")
            .attr("x", Math.cos(majorityAngle) * radius * 1.1)
            .attr("y", Math.sin(majorityAngle) * radius * 1.1 - 5) // 少し上に
            .attr("text-anchor", "middle")
            .attr("fill", "#F56565")
            .style("font-size", "14px")
            .style("font-weight", "600")
            .text("過半数 (233)");

        // --- 4. シミュレーションUI (コントロール) の生成 ---
        const controlsContainer = document.getElementById("controls-container");
        const resultDisplay = document.getElementById("total-seats-display");
        const statusDisplay = document.getElementById("majority-status");
        const resultCard = document.getElementById("simulation-result");

        partyData.forEach((party, index) => {
            const label = document.createElement("label");
            label.className = "flex items-center p-3 bg-gray-800 rounded-md hover:bg-gray-600 transition duration-200 cursor-pointer";
            label.style.color = party.color; 

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.className = "party-checkbox h-5 w-5 rounded border-gray-500 text-gray-500 focus:ring-0 focus:ring-offset-0";
            checkbox.dataset.id = party.id; // D3のデータキー
            checkbox.style.color = party.color; 

            const text = document.createElement("span");
            text.className = "ml-3 font-semibold";
            text.textContent = `${party.name} (${party.seats}議席)`;

            label.appendChild(checkbox);
            label.appendChild(text);
            controlsContainer.appendChild(label);

            checkbox.addEventListener("change", updateSimulation);
        });

        // --- 5. グラフ更新関数 ---
        
        // アニメーション用Tween関数
        function arcTween(d) {
            const i = d3.interpolate(this._current, d);
            this._current = i(0);
            return function(t) {
                return arc(i(t));
            };
        }
        
        // ツールチップ用ハンドラ
        function handleMouseOver(event, d) {
            // 「残り議席」ではツールチップを出さない
            if (d.data.id === 'remaining') return;
            
            d3.select(this)
                .transition().duration(200)
                .attr("d", arcHover);
            tooltip
                .style("visibility", "visible")
                .style("opacity", 1)
                .html(`<strong>${d.data.name}</strong><br>${d.data.seats} 議席`);
        }
        function handleMouseMove(event) {
            tooltip
                .style("top", (event.pageY - 10) + "px")
                .style("left", (event.pageX + 10) + "px");
        }
        function handleMouseOut(event, d) {
            // 「残り議席」では何もしない
            if (d.data.id === 'remaining') return;

            d3.select(this)
                .transition().duration(200)
                .attr("d", arc);
            tooltip
                .style("visibility", "hidden")
                .style("opacity", 0);
        }

        // --- 6. シミュレーション更新ロジック (D3 General Update Pattern) ---
        function updateSimulation() {
            let totalSelectedSeats = 0;
            const selectedParties = [];

            // チェックボックスの状態を読み取り、データ配列を作成
            document.querySelectorAll(".party-checkbox:checked").forEach(cb => {
                const partyId = cb.dataset.id;
                const party = partyData.find(p => p.id === partyId);
                if (party) {
                    selectedParties.push(party);
                    totalSelectedSeats += party.seats;
                }
            });

            // 残り議席（未選択）のデータを計算
            const remainingSeats = TOTAL_SEATS - totalSelectedSeats;
            // 「残り議席」が0未満にならないように
            const finalRemainingSeats = Math.max(0, remainingSeats);
            
            const dynamicData = [
                ...selectedParties, 
                // 「残り議席」を必ず末尾に追加
                { id: 'remaining', name: '残り議席', seats: finalRemainingSeats, color: '#2D3748' } // bg-gray-700
            ];

            // --- D3 Update Pattern ---
            const pieData = pie(dynamicData);

            svg.selectAll("path.party-slice")
                .data(pieData, d => d.data.id) // idをキーとしてデータを結合
                .join(
                    // Enter: 新しく追加された要素
                    enter => enter.append("path")
                        .attr("class", "party-slice")
                        .attr("fill", d => d.data.color)
                        .attr("stroke", "#1a202c")
                        .style("stroke-width", "2px")
                        .on("mouseover", handleMouseOver)
                        .on("mousemove", handleMouseMove)
                        .on("mouseout", handleMouseOut)
                        .each(function(d) {
                            // アニメーションの開始状態を保存
                            this._current = { ...d, startAngle: d.startAngle, endAngle: d.startAngle };
                        })
                        .transition()
                        .duration(750)
                        .attrTween("d", arcTween),
                    
                    // Update: 既存の要素 (角度が変わる)
                    update => update
                        .transition()
                        .duration(750)
                        .attrTween("d", arcTween),
                        
                    // Exit: 不要になった要素 (チェックを外した会派)
                    exit => exit
                        .transition()
                        .duration(500)
                        .attrTween("d", function(d) {
                            // 畳んで消えるアニメーション
                            const i = d3.interpolate(d, { ...d, endAngle: d.startAngle });
                            return function(t) {
                                return arc(i(t));
                            };
                        })
                        .remove()
                );

            // --- 結果表示を更新 ---
            resultDisplay.textContent = `${totalSelectedSeats} 議席`;

            if (totalSelectedSeats >= MAJORITY_LINE_SEATS) {
                statusDisplay.textContent = `過半数 (233議席) 達成`;
                resultDisplay.className = "text-5xl font-bold text-green-400";
                statusDisplay.className = "text-xl font-semibold mt-2 text-green-400";
                resultCard.classList.remove("border-yellow-400");
                resultCard.classList.add("border-green-400");
            } else {
                statusDisplay.textContent = `過半数 (233議席) 未達`;
                resultDisplay.className = "text-5xl font-bold text-yellow-400";
                statusDisplay.className = "text-xl font-semibold mt-2 text-yellow-400";
                resultCard.classList.remove("border-green-400");
                resultCard.classList.add("border-yellow-400");
            }
        }
        
        // 初期状態（0議席）でグラフを描画
        updateSimulation();

    </script>
</body>
</html>

